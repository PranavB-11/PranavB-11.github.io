<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 4: Neural Radiance Fields</title>
    <link rel="stylesheet" href="../style.css"> 
    <link rel="stylesheet" href="style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <nav>
        <ul>
            <li><a href="../index.html" class="back-arrow">&larr;</a></li>
            <li><a href="../Project 0/index.html" class="project-link">Project 0</a></li>
            <li><a href="../Project 1/index.html" class="project-link">Project 1</a></li>
            <li><a href="../Project 2/index.html" class="project-link">Project 2</a></li>
            <li><a href="../Project 3/index.html" class="project-link">Project 3</a></li>
            <li><a href="index.html" class="project-link active">Project 4</a></li>
            <li><a href="../Project 5/index.html" class="project-link">Project 5</a></li>
        </ul>
    </nav>

    <div class="main-container" style="padding-top: 80px; padding-bottom: 10px;">
        <h1 style="font-size: 3.5rem;">Project 4: Neural Radiance Fields</h1>
    </div>

    <div class="project-content" style="padding-top: 20px;">

        <div class="section">
            <h2>Part 0: Camera Calibration and 3D Scanning</h2>
            
            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Camera Frustums Visualization</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/frustum1.png" alt="Camera frustum visualization 1" style="max-width: 100%; height: auto; border-radius: 8px;">
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/frustum2.png" alt="Camera frustum visualization 2" style="max-width: 100%; height: auto; border-radius: 8px;">
                </figure>
            </div>
        </div>

        <div class="section">
            <h2>Part 1: Fit a Neural Field to a 2D Image</h2>
            
            <div style="max-width: 960px; margin: 0 auto 40px auto; text-align: left; line-height: 1.6;">
                <h3>Model Architecture</h3>
                <p>The model is composed of a positional encoding layer followed by a standard Multi-Layer Perceptron (MLP).</p>
                <ul style="margin-left: 20px; margin-bottom: 20px;">
                    <li><strong>Positional Encoding (PE):</strong>
                        <ul>
                            <li>Input Dimension: 2 (for 2D `(x, y)` coordinates).</li>
                            <li>Max Frequency (L): 10</li>
                            <li>Output Dimension: 42 (Calculated as `2 + 2 * 2 * 10 = 42`).</li>
                        </ul>
                    </li>
                    <li><strong>MLP Architecture:</strong>
                        <ul>
                            <li>Input Dimension: 42 (from the PE output).</li>
                            <li>Hidden Width: 256 neurons.</li>
                            <li>Number of Hidden Layers: 6</li>
                            <li>Total Linear Layers: 8 (1 input, 6 hidden, 1 output).</li>
                            <li>Activation: `nn.ReLU()` for all hidden layers.</li>
                            <li>Output Activation: `nn.Sigmoid()` to constrain output to `[0, 1]`.</li>
                        </ul>
                    </li>
                </ul>

                <h3>Training Details</h3>
                <ul style="margin-left: 20px;">
                    <li><strong>Optimizer:</strong> Adam</li>
                    <li><strong>Learning Rate:</strong> 1e-3</li>
                    <li><strong>Loss Function:</strong> Mean Squared Error (MSE)</li>
                    <li><strong>Batch Size (N):</strong> 10,000 pixels per iteration.</li>
                    <li><strong>Total Iterations:</strong> 3,000</li>
                    <li><strong>Normalization:</strong> Both input coordinates and ground-truth RGB colors were normalized to the `[0, 1]` range.</li>
                </ul>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Training Progression (Fox Image)</h3>
            <div class="image-gallery" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_0_fox.png" alt="Fox Iteration 0" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 0</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_100_fox.png" alt="Fox Iteration 100" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 100</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_500_fox.png" alt="Fox Iteration 500" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 500</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_1000_fox.png" alt="Fox Iteration 1000" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 1000</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2000_fox.png" alt="Fox Iteration 2000" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2000</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2500_fox.png" alt="Fox Iteration 2500" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2500</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2999_fox.png" alt="Fox Iteration 2999" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2999</figcaption>
                </figure>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Training Progression (My Image)</h3>
            <div class="image-gallery" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_0.png" alt="My Image Iteration 0" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 0</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_100.png" alt="My Image Iteration 100" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 100</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_500.png" alt="My Image Iteration 500" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 500</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_1000.png" alt="My Image Iteration 1000" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 1000</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2000.png" alt="My Image Iteration 2000" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2000</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2500.png" alt="My Image Iteration 2500" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2500</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 30%;">
                    <img src="cs180proj4/reconstructed_iter_2999.png" alt="My Image Iteration 2999" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Iteration 2999</figcaption>
                </figure>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Hyperparameter Tuning (2x2 Grids)</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/2x2_grid_results_fox.png" alt="Fox 2x2 Grid" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Fox Image Grid</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/2x2_grid_results.png" alt="My 2x2 Grid" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">My Image Grid</figcaption>
                </figure>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">PSNR Curves</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/psnr_curve_fox.png" alt="Fox PSNR Curve" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Fox PSNR Curve</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/psnr_curve.png" alt="My PSNR Curve" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">My Image PSNR Curve</figcaption>
                </figure>
            </div>
        </div>
        
        <div class="section">
            <h2>Part 2: Fit a Neural Radiance Field from Multi-view Images</h2>
            
            <div style="max-width: 960px; margin: 0 auto 40px auto; text-align: left; line-height: 1.6;">
                <p><strong>Part 2.1: Create Rays from Cameras</strong><br>
                    I wrote 3 functions: `pixel_to_camera` which un-projects a 2D pixel into 3D camera space, `transform_c2w` which converts a 3D point from camera space to world space, and `pixel_to_ray` which combines the first two to generate a ray for any given pixel.
                </p>
                <p><strong>Part 2.2: Sampling</strong><br>
                    This implements the `sample_along_rays` function. Since a ray is continuous, we must sample discrete 3D points along it to feed into the network. During training, we divide the ray into bins and pick a random point within each bin (stratified sampling), which prevents aliasing and encourages the model to learn a smooth continuous 3D representation.
                </p>
                <p><strong>Part 2.3: Dataloading</strong><br>
                    This part creates the `RaysData` class which pre-computes the ray origin and direction for every single pixel in the entire training set and stores them in arrays. This makes the training loop much faster since this is a one-time upfront computation. Then, I use `viser` to visualize poses, a few sampled rays, and the 3D points along them to verify that the ray generation and sampling logic are correct.
                </p>
                <p><strong>Part 2.4: NeRF</strong><br>
                    This defines the NeRF Model: an 8-layer MLP with a skip connection. The model is split into two parts: one that takes a 3D position and outputs a volume density, and a head that takes the view direction and features from the prior part to output the final RGB color.
                </p>
                <p><strong>Part 2.5: Volume Rendering and Training</strong><br>
                    The `volrend` function is the rendering equation taking sigma and RGB values for all points along a ray and calculating the final pixel color by summing their contributions weighted by opacity and light. The main training loop then samples a large batch of pre-calculated rays, gets the model's output, and renders the color using `volrend` and computes the MSE loss against the true pixel color.
                </p>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Visualization of Rays and Samples</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/lego_viz1.png" alt="Lego ray visualization 1" style="max-width: 100%; height: auto; border-radius: 8px;">
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/lego_viz2.png" alt="Lego ray visualization 2" style="max-width: 100%; height: auto; border-radius: 8px;">
                </figure>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Training Progression Visualization</h3>
            <figure style="text-align: center; max-width: 70%; margin: 20px auto 40px auto;">
                <img src="cs180proj4/training_progression.gif" alt="Lego training progression GIF" style="max-width: 100%; height: auto; border-radius: 8px;">
                <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Training progression on the Lego dataset.</figcaption>
            </figure>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">PSNR Curve</h3>
            <figure style="text-align: center; max-width: 70%; margin: 20px auto 40px auto;">
                <img src="cs180proj4/psnrcurvelego.png" alt="Lego PSNR Curve" style="max-width: 100%; height: auto; border-radius: 8px;">
                <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Validation PSNR curve for the Lego dataset.</figcaption>
            </figure>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Video Rendering</h3>
            <figure style="text-align: center; max-width: 70%; margin: 20px auto 40px auto;">
                <video controls autoplay loop muted style="max-width: 100%; height: auto; border-radius: 8px;">
                    <source src="cs180proj4/novel_view_video.mp4" type="video/mp4">
                </video>
                <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Novel view synthesis video of the Lego scene.</figcaption>
            </figure>

        </div>
        
        <div class="section">
            <h2>Part 2.6: Training With Your Own Data</h2>
            
            <div style="max-width: 960px; margin: 0 auto 40px auto; text-align: left; line-height: 1.6;">
                <p>
                    I set the hyperparameters as follows for my data:
                </p>
                <ul style="margin-left: 20px;">
                    <li><strong>Learning Rate:</strong> 1e-4</li>
                    <li><strong>Number of Iterations:</strong> 5000</li>
                    <li><strong>Batch Size:</strong> 4096</li>
                    <li><strong>Samples Per Ray:</strong> 64</li>
                    <li><strong>Near, Far:</strong> 0.02, 0.5</li>
                </ul>
                <p>
                    These hyperparameters worked reasonably well with the Lafufu Dataset (only increasing the LR to 5e-4) showing a validation PSNR of around 22 at its peak. However, for my data, I noticed severe overfitting (training loss decreasing while validation PSNR also decreasing). I tried to adjust the hyperparameters but saw no significant progress of the validation PSNR that peaked around 15. So, I went back to Part 0, adjusted my K matrix to get rid of the fish bowl lens distortion that was happening by zeroing out all K values except K1, then cropping to the appropriate region of interest. This fixed the quality of the final output, however, the validation PSNR still displays overfitting, even after adjusting the hyperparameters post-data modification. Hence, this is what I have:
                </p>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Renders during Training and Novel Views</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/my_data_progression.gif" alt="My Data Training Progression" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Training progression on my data.</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <video controls autoplay loop muted style="max-width: 100%; height: auto; border-radius: 8px;">
                        <source src="cs180proj4/my_object_video.mp4" type="video/mp4">
                    </video>
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Novel view orbital render of my object.</figcaption>
                </figure>
            </div>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Training Loss</h3>
            <figure style="text-align: center; max-width: 70%; margin: 20px auto 40px auto;">
                <img src="cs180proj4/my_data_train_loss_curve.png" alt="My Data Training Loss Curve" style="max-width: 100%; height: auto; border-radius: 8px;">
                <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Training loss curve for my data.</figcaption>
            </figure>

            <h3 style="text-align: center; font-weight: 500; margin-top: 40px; margin-bottom: 20px;">Lafufu Rendering</h3>
            <div class="image-gallery" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 40px;">
                <figure style="text-align: center; max-width: 45%;">
                    <img src="cs180proj4/lafufu_progression.gif" alt="Lafufu Training Progression" style="max-width: 100%; height: auto; border-radius: 8px;">
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Lafufu dataset training progression.</figcaption>
                </figure>
                <figure style="text-align: center; max-width: 45%;">
                    <video controls autoplay loop muted style="max-width: 100%; height: auto; border-radius: 8px;">
                        <source src="cs180proj4/lafufu_vid.mp4" type="video/mp4">
                    </video>
                    <figcaption style="margin-top: 10px; font-style: italic; color: #555;">Lafufu dataset novel view render.</figcaption>
                </figure>
            </div>

        </div>

    </div>

</body>
</html>